# Google Cloud Deployment Playbook

This guide provides a field-tested checklist for provisioning every Google Cloud resource required by the Neuralight Pro Codex branch. Follow each step in order; you can tick boxes as you progress.

## 0. Pre-flight Checklist

- [ ] Google Cloud project created and you have **Project Owner** or equivalent permissions
- [ ] `gcloud` CLI installed locally and initialized with `gcloud init`
- [ ] Billing enabled on the target project

Once these prerequisites are satisfied, continue with the sections below.

## 1. Enable Required Google Cloud APIs

You can enable APIs in the Cloud Console or with the CLI. The project must have the following services turned on **before** deploying:

| Service | Console Navigation | CLI Command |
| --- | --- | --- |
| Cloud Storage API | Console ‚Üí Navigation Menu ‚Üí **APIs & Services** ‚Üí **Library** ‚Üí Search "Cloud Storage" ‚Üí **Enable** | `gcloud services enable storage.googleapis.com` |
| IAM Service Account Credentials API | Same path, search for "IAM Service Account Credentials API" ‚Üí **Enable** | `gcloud services enable iamcredentials.googleapis.com` |
| Cloud Run Admin API | Same path, search for "Cloud Run Admin API" ‚Üí **Enable** | `gcloud services enable run.googleapis.com` |
| Artifact Registry API *(if building images inside GCP)* | Same path, search "Artifact Registry API" ‚Üí **Enable** | `gcloud services enable artifactregistry.googleapis.com` |
| Secret Manager API *(recommended for credential storage)* | Same path, search "Secret Manager API" ‚Üí **Enable** | `gcloud services enable secretmanager.googleapis.com` |

> ‚úÖ Tip: Run the CLI commands back-to-back to avoid missing a dependency when you automate deployments.

## 2. Create the Cloud Storage Bucket

1. Open the Console ‚Üí **Navigation Menu** ‚Üí **Cloud Storage** ‚Üí **Buckets** ‚Üí **Create**.
2. Choose **Your project** and supply a globally-unique bucket name. This will become the value for `GCS_BUCKET_NAME` (example: `photo-bio-prod-assets`).
3. Select a **Location type** and region (for example, "Region" ‚Üí `us-central1`). Pick the same region you plan to use for Cloud Run to minimize latency.
4. Under **Default storage class**, choose **Standard** unless you have a cost reason to change.
5. Leave **Access control** set to **Uniform** (recommended). This ensures IAM permissions apply consistently.
6. Click **Create**.

### Optional Bucket Settings

- **Public Access**: Leave public access disabled. Signed URLs generated by the app will provide controlled downloads.
- **Lifecycle Rules**: You can configure automatic cleanup for expired assets if desired.
- **CORS**: Not required because assets are downloaded via signed URLs. Only configure if you later host public images directly.

## 3. Provision a Dedicated Service Account

1. Console ‚Üí **Navigation Menu** ‚Üí **IAM & Admin** ‚Üí **Service Accounts** ‚Üí **Create service account**.
2. Name it `photo-bio-storage-writer` (or similar) and add a description such as "Uploads generated media to Cloud Storage".
3. Click **Create and continue**.
4. Grant the service account the following roles:
   - **Storage Object Admin** (`roles/storage.objectAdmin`) ‚Äì allows creating, updating, and deleting objects in the bucket.
   - **Service Account Token Creator** (`roles/iam.serviceAccountTokenCreator`) ‚Äì required when binding the account to Cloud Run for token-based access.
5. Click **Done**.

> ‚ÑπÔ∏è Screenshot request: This environment cannot capture screenshots, but when assigning roles you should see the two roles above listed under "Grant this service account access to the project".

## 4. Bind the Service Account to the Bucket

Grant the new service account access to the bucket itself:

1. Cloud Storage ‚Üí **Buckets** ‚Üí select your bucket ‚Üí **Permissions** tab.
2. Click **Grant access** and enter the service account email (`photo-bio-storage-writer@<project-id>.iam.gserviceaccount.com`).
3. Assign the **Storage Object Admin** role at the bucket level and save.

This explicit binding ensures the account can access the bucket even if project-level roles change later.

## 5. Generate and Store Service Account Credentials

You can supply credentials to Cloud Run in two ways. Pick **one** of the options below.

### Option A: Workload Identity Federation (Recommended)

1. When deploying to Cloud Run, assign the service account directly (see Section 7). No keys need to be created.
2. Skip to **Section 6**. Cloud Run will inject the credentials automatically.

### Option B: JSON Key Stored as a Secret

1. IAM & Admin ‚Üí **Service Accounts** ‚Üí select the account ‚Üí **Keys** ‚Üí **Add key** ‚Üí **Create new key** ‚Üí choose **JSON**.
2. Download the JSON file. **Do not commit it to source control.**
3. Create a Secret Manager secret to store the raw JSON:
   ```bash
   printf '%s' "$(cat service-account.json)" | gcloud secrets create photo-bio-gcs-key --data-file=-
   ```
4. Grant your Cloud Run runtime service account access to the secret:
   ```bash
   gcloud secrets add-iam-policy-binding photo-bio-gcs-key \
     --member="serviceAccount:photo-bio-storage-writer@<project-id>.iam.gserviceaccount.com" \
     --role="roles/secretmanager.secretAccessor"
   ```
5. When deploying, mount the secret as a file and set `GOOGLE_APPLICATION_CREDENTIALS` to the mounted path (instructions in Section 6).

## 6. Environment Variables & Secrets

Add the following secrets to your environment. Values marked **(new)** were introduced by the latest code changes.

| Variable | Purpose | Where to Find It |
| --- | --- | --- |
| `NEXT_PUBLIC_MEMBERSTACK_PUBLIC_KEY` | Client-side Memberstack initialization key | Memberstack Dashboard ‚Üí **Settings ‚Üí API Keys ‚Üí Publishable Key** |
| `NEXT_PUBLIC_MEMBERSTACK_APP_ID` | Optional Memberstack app identifier | Memberstack Dashboard ‚Üí **Settings ‚Üí App Info** |
| `NEXT_PUBLIC_XANO_API_URL` | Xano API base URL used by the frontend | Xano Project ‚Üí **Settings ‚Üí API Base URL** |
| `OPENAI_API_KEY` | Server-side OpenAI access | OpenAI Dashboard ‚Üí **View API Keys** |
| `MEMBERSTACK_SECRET_KEY` | Server-side Memberstack verification key | Memberstack Dashboard ‚Üí **Settings ‚Üí API Keys ‚Üí Secret Key** |
| `MEMBERSTACK_VERIFY_ENDPOINT` | Override for token verification (optional) | Defaults to `https://api.memberstack.com/v2/members/verify-access-token` |
| `API_ACCESS_TOKEN` | Fallback bearer token for scheduled jobs | Generate a long random string (e.g., `openssl rand -hex 32`) |
| `GCS_BUCKET_NAME` **(new)** | Target bucket for generated assets | Name chosen in Section 2 |
| `GCP_PROJECT_ID` **(new)** | Google Cloud project ID | Cloud Console header or `gcloud config get-value project` |
| `GOOGLE_APPLICATION_CREDENTIALS` | File path to mounted service-account JSON (if using Option B) | Set during deployment (e.g., `/var/secrets/google/key.json`) |
| `GOOGLE_APPLICATION_CREDENTIALS_JSON` *(optional)* | Raw JSON string if your platform requires inline credentials | Paste the full JSON (single-line) into the secret value |

> üîê Secret Management Best Practice: On Cloud Run use Secret Manager references (`--set-secrets`) instead of plain environment variables for sensitive values.

## 7. Deploy to Cloud Run

### 7.1 Build the Container Image

If you deploy from your workstation:

```bash
# Authenticate Docker with Artifact Registry (one-time per project/region)
gcloud auth configure-docker us-central1-docker.pkg.dev

# Build and push the image
PROJECT_ID=$(gcloud config get-value project)
REGION=us-central1
SERVICE=photo-bio-codex
IMAGE="us-central1-docker.pkg.dev/${PROJECT_ID}/photo-bio/photo-bio-codex:$(git rev-parse --short HEAD)"

docker build -t "${IMAGE}" .
docker push "${IMAGE}"
```

> Prefer Artifact Registry over Container Registry because Google is deprecating the latter.

### 7.2 Deploy the Service

```bash
PROJECT_ID=$(gcloud config get-value project)
REGION=us-central1
SERVICE=photo-bio-codex
IMAGE="us-central1-docker.pkg.dev/${PROJECT_ID}/photo-bio/photo-bio-codex:$(git rev-parse --short HEAD)"
SERVICE_ACCOUNT="photo-bio-storage-writer@${PROJECT_ID}.iam.gserviceaccount.com"

# Example deployment command
gcloud run deploy "${SERVICE}" \
  --region "${REGION}" \
  --image "${IMAGE}" \
  --service-account "${SERVICE_ACCOUNT}" \
  --allow-unauthenticated \
  --set-env-vars "NEXT_PUBLIC_MEMBERSTACK_PUBLIC_KEY=..." \
  --set-env-vars "NEXT_PUBLIC_MEMBERSTACK_APP_ID=..." \
  --set-env-vars "NEXT_PUBLIC_XANO_API_URL=..." \
  --set-env-vars "MEMBERSTACK_VERIFY_ENDPOINT=https://api.memberstack.com/v2/members/verify-access-token" \
  --set-env-vars "GCS_BUCKET_NAME=photo-bio-prod-assets" \
  --set-env-vars "GCP_PROJECT_ID=${PROJECT_ID}" \
  --set-secrets "OPENAI_API_KEY=projects/${PROJECT_ID}/secrets/openai-api-key:latest" \
  --set-secrets "MEMBERSTACK_SECRET_KEY=projects/${PROJECT_ID}/secrets/memberstack-secret:latest" \
  --set-secrets "API_ACCESS_TOKEN=projects/${PROJECT_ID}/secrets/api-access-token:latest"
```

If you are using the JSON key secret (Option B), mount it during deployment:

```bash
  --set-secrets "GOOGLE_APPLICATION_CREDENTIALS_JSON=projects/${PROJECT_ID}/secrets/photo-bio-gcs-key:latest" \
  --update-env-vars "GOOGLE_APPLICATION_CREDENTIALS=/var/secrets/google/key.json" \
  --volume "google-key=/var/secrets/google" \
  --volume-mount "/var/secrets/google/key.json=google-key:GOOGLE_APPLICATION_CREDENTIALS_JSON"
```

Alternatively, manually create a secret-mounted volume in the Cloud Run UI and point `GOOGLE_APPLICATION_CREDENTIALS` to the file path shown in the console.

### 7.3 Attach Service Account via Console

If you prefer the UI:

1. Console ‚Üí **Cloud Run** ‚Üí select the service ‚Üí **Edit & Deploy New Revision**.
2. Under **Container**, click **Runtime service account** and pick the service account created in Section 3.
3. Scroll to **Variables & Secrets** to add environment variables. Use **Secret Manager** references for sensitive keys.
4. If mounting JSON credentials, add a secret volume under **Volumes** and specify the mount path (for example `/var/secrets/google/key.json`).
5. Click **Deploy**.

## 8. Post-Deployment Verification

- Trigger a test request to `/api/generate-blog-image` and confirm that images are uploaded to the bucket under the expected folder.
- Verify that unauthenticated requests receive a 401 response, confirming auth middleware is active.
- In Cloud Run logs, check for warnings about missing credentials or storage permissions.

Following this guide end-to-end ensures the application is production-ready on Google Cloud Run with secure access to Cloud Storage and external APIs.
